---
title: "Differential gene expression"
date: "`r format(Sys.time(), '%d %B, %Y')`"
format:
  html:
    embed-resources: true
    code-fold: show
params:
  morf: "epi"
  fig.path: "`r paste0(params$fig.path)`" #./Figures/
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(#fig.width = 6.6929133858,
  fig.path      = params$fig.path,#"../Figures/",
  fig.align     = "center",
  message       = FALSE,
  warning       = FALSE,
  dev           = c("jpeg", "pdf"),
  dpi           = 300,
  fig.process = function(filename){
    new_filename <- stringr::str_remove(string = filename,
                                        pattern = "-1")
    fs::file_move(path = filename, new_path = new_filename)
    ifelse(fs::file_exists(new_filename), new_filename, filename)
  }
  )
# setwd("/Users/vilkal/work/Brolidens_work/Projects/ST_DMPA/src")
```

```{r background_job, eval=FALSE, include=FALSE}
source("../bin/render_with_jobs.R")
file_name <- "./06_DGE_condition_st_data.md"

file <- paste0(basename(xfun::sans_ext(file_name)), '_', Sys.Date(), '.html')

# quarto
# render_html_with_job(out_dir = lab_dir)
# fs::file_move(path = file, new_path = paste0(lab_dir, file))

# currently using quarto for github and kniter for html due to source code option 
render_git_with_job(fig_path = "../Figures/06/")

# kniter
knit_html_with_job(out_dir = "../lab_book/06_DGE_condition_st_data", fig_path = "./Figures/06/")
```

## Load data and libraries

```{r Load_data}
##################
# LOAD LIBRARIES #
##################
library(tidyverse)
library(Seurat)
library(SeuratObject)
library(tidyseurat)
library(cowplot)
library(ggrepel)
library(niceRplots)
library(MAST)
library(scran)
library(openxlsx)

source("../bin/plotting_functions.R")

#########
# PATHS #
#########
input_dir <- "../results/04_deconvolution_st_data/"
result_dir <- "../results/06_DGE_condition_st_data/"
marker_dir <- "./marker_genes_condition/"
if( isFALSE(dir.exists(result_dir)) ) { dir.create(result_dir,recursive = TRUE) }
if( isFALSE(dir.exists(marker_dir)) ) { dir.create(marker_dir,recursive = TRUE) }
PlosPath_DGEs <- "/Users/vilkal/work/Brolidens_work/Projects/Spatial_DMPA/data/Bulk_data/DMPA_PlosPath_DEGs.csv"

#############
# LODA DATA #
#############
#DATA <- readRDS(paste0(input_dir,"seuratObj_deconvolution.RDS"))
DATA <- readRDS(paste0("../results/03_clustering_st_data/","seuratObj_clustered_filt.RDS"))
DGEs_PP <- read_csv(PlosPath_DGEs)
epi_clus <- "^5$|^6$|^8|^9|11|12" # non-filt
#Clus_split <- rep(c("0$|^1$|^2|^3|^4|^7|10|13|14","^5|^6|^8|^9|11|12"),2) # filt
#Clus_split <- c("^5$|^6$|^7$|^8|^9|11|12", "^0$|^1$|^2|^3$|^4$|^5$|10|13|14|15|16") # non-filt
```

```{r Functions}
########################
# SEURAT DGEs FUNCTION #
########################
# obj <- DATA_sub$data[[1]]
# condition <- 'groups'
# subgroup <- "Clusters"
DEGs_fun <- function(obj, condition, subgroup){
  obj <- SetIdent(obj, value = condition)
  
  DATA_degs <- obj %>%
  mutate(clus = .data[[subgroup]]) %>%
  nest(data = -c("clus")) %>%
  mutate( DEGs = map(data, 
        ~FindAllMarkers(.x,
                       test.use = "wilcox",
                       only.pos = F,
                       return.thresh = 1,
                       max.cells.per.ident = Inf,
                       logfc.threshold = -Inf,
                       assay = "RNA",
                       min.pct = -Inf)
                    ))

  DEGs_table <- DATA_degs %>%
    mutate(DEGs = setNames( .[["DEGs"]], .$clus)) %>%
    .$DEGs %>%
    map(., ~as_tibble(.x)) %>%
    #map2(., comb$comb, ~mutate(.x, Combination = .y)) %>%
    bind_rows(., .id = "subgroup") %>%
    mutate(pct.diff = -.$pct.2-.$pct.1) %>%
    mutate(log.pct.diff = -log2(.$pct.2/.$pct.1))
  return(DEGs_table)
}
```

```{r Subset, eval=FALSE, include=TRUE, eval=T}
####################################
# SUBSET SEURAT OBJECT PER CLUSTER #
####################################
# tidy code:
# creating a subseted object with 25 spots per sampleID for each cluster

DATA_sub <- DATA %>%
  filter(!(sp_annot == "SubMuc" & Clusters == 12)) %>%
  #mutate(morf = ifelse(grepl("epi", .$sp_annot), "epi", "SubMuc" )) %>%
  mutate(gr = .$groups) %>%
  mutate(ID = .$orig.ident) %>%
  nest(., data=-c(gr, orig.ident)) %>%
  mutate(n_spot_before = map(data, ~table(.x$Clusters))) %>%
  mutate(data = map(data, ~filter(.x, .cell %in% WhichCells(., downsample = 25)))) %>%
  # mutate(data = map2(data, Clus_split, ~filter(.x, grepl(.y, .x$Clusters)))) %>%
  mutate(n_spot_after = map(data, ~table(.x$Clusters))) %>%
  #arrange(gr) %>%
  mutate(across(starts_with("n_spot_"), ~set_names(.x, paste0(.data[["orig.ident"]],"_",.data[["gr"]])))) 
      
table(DATA$Clusters)

DATA_sub$n_spot_after

bind_cols(DATA_sub$n_spot_before, .id = names(table(DATA$Clusters)))
bind_cols(DATA_sub$n_spot_after, .id = names(table(DATA$Clusters)))


```

```{r DEGs, include=TRUE, eval=FALSE}
t <- DATA_sub %>%
  #mutate(data = map2(data, Clus_split, ~filter(.x, grepl(.y, .x$Clusters)))) %>%
  unnest(data) %>% nest(data=-c(morf, gr)) %>%
  mutate(n_spot_after = map(data, ~table(.x$Clusters))) %>%
  mutate(across(starts_with("n_spot_"), ~set_names(.x, paste0(.data[["morf"]],"_",.data[["gr"]])))) %>%
  .$n_spot_after
##############################################
# DGEs BETWEEN CONDITION FOR EACH SUBGROUPS #
##############################################
DEGs_table <- DATA_sub %>%
  unnest(data) %>%
  #filter(Clusters == 6 | Clusters == 8) %>%
  DEGs_fun(., "groups", "Clusters")


###################
# ADD ANNOTATION #
##################
# "Sup_0","Sup_1","Sup_2","Intrmed","Basal_2","Basal_1"
# ord1 <- c("0","1","2","3","4","Sup_2","Intrmed","7","Sup_1","Basal_1","10","Basal_2","Sup_0","13","14")
ord1 <- c("Sup_0","Sup_1","Sup_2","Intrmed","Basal_2","Basal_1","0","1","2","3","4","7","10","13","14")
ord2 <- c("12","8","5","6","11","9","0","1","2","3","4","7","10","13","14")
epi_layers <- set_names(ord1, ord2)

DEGs_table <- DEGs_table %>%
  mutate(subgroup = factor(.$subgroup, levels = ord2)) %>%
  mutate(layers = factor(epi_layers[as.character(.$subgroup)], levels = ord1)) 

```

```{r save_DGEs, include=TRUE, eval=FALSE}
# saveRDS(list(DATA_sub=DATA_sub, DEGs_table=DEGs_table), paste0(result_dir, "DATA_sub_25.RDS"))
# write_csv(DEGs_table, paste0(result_dir, "DGEs_condition_wilcox_", "25.csv"))

DEGs_list <- DEGs_table %>% 
  mutate(morf = ifelse(grepl(epi_clus, .$subgroup), "epi", "SubMuc")) %>%
  nest(data=-c(morf)) %>%
  mutate(data = setNames( .[["data"]], .$morf)) %>%
  .$data %>%
  map(., ~split(.x, .x$layers)) 

imap(DEGs_list, ~write.xlsx(.x, keepNA=TRUE, na.string="NA", overwrite=TRUE,
           file=paste0(result_dir,"DGEs_condition_wilcox_",.y,"_25.xlsx")))
```

```{r get_DEGs}
# Load data
DATA_sub <- readRDS(paste0(result_dir, "DATA_sub_25.RDS"))
DEGs_table <- DATA_sub$DEGs_table %>% filter(cluster == "DMPA")
DATA_sub <- DATA_sub$DATA_sub 
```


```{r volcano_plot_DGEs_perClus}
################
# VOLCANO PLOT #
################
# epi
DEGs_filt <- DEGs_table %>% 
  filter(grepl(epi_clus, .$subgroup)) %>%
  filter(p_val < 0.099) 
Volcano.fun_logFC(DEGs_filt, "layers", y.axis="p-value", 
                  up=c(.5, 0.05), down = c(-.5, 0.05)) # labeling: (logFC, p-value)

# SubMucosa
DEGs_filt <- DEGs_table %>% 
  #filter(grepl(epi_clus, .$subgroup)) %>%
  filter(!(grepl(epi_clus, .$subgroup))) %>%
  filter(p_val < 0.099) 
Volcano.fun_logFC(DEGs_filt, "layers", y.axis="p-value", 
                  up=c(.5, 0.05), down = c(-.5, 0.05)) # labeling: (logFC, p-value)
```

```{r top_sig_genes}
# Significant genes from the PlosPath study
# Genes with FDR-adjustedP-values<0.05 were considered significant
PP_sig <- DGEs_PP %>%
  filter(DE != 0) %>%
  {. ->> sig_PP } %>%
  group_by(DE) %>%
  top_n(15, abs(logFC))

# top 15 genes sorted by logFC for each epithelial layer
epi <- DEGs_table %>%
  mutate(Direction = ifelse(avg_log2FC > 0, "UP", "DOWN")) %>%
  filter(p_val_adj < 0.05) %>%
  {. ->> sig_epi } %>%
  group_by(layers, Direction) %>%
  top_n(15, abs(avg_log2FC)) %>% 
  #top_n(-30, p_val) %>% 
  nest() %>% mutate(n = map_dbl(data, nrow)) %>%
  arrange(Direction, layers)

epi_sig_genes <- unnest(epi, c(layers, Direction, data))

sig_epi %>%
  group_by(layers, Direction) %>%
  nest() %>% mutate(n = map_dbl(data, nrow)) %>%
  arrange(layers)
#knitr::kable(epi_sig_genes)
```

```{r violplot_sig_DEGs, fig.height=7}
#########################
# OVERVIWE OF SIG. DEGs #
#########################
l <- length(unique(sig_epi$layers))
s1 <- sig_epi %>%
    ggplot(., aes(x=Direction, y=abs(avg_log2FC), fill = Direction )) +
    geom_violin() + #ylim(c(0, m)) + ggtitle(feature) +
    geom_jitter(width = 0.3, alpha = 0.3, size=.1) +
    geom_boxplot(width=0.1, color="black", alpha=0.2) +
    facet_wrap("layers", ncol = l) +
    scale_fill_manual(values = c("#67A9CF", "#EF8A62")) +
    theme_minimal() + NoLegend() +
    theme(axis.title.x = element_blank()) 

s2 <- sig_epi %>%
  mutate(Dir = .$Direction) %>%
  group_by(Dir) %>%
  nest() %>%
  bind_cols(., tibble(col = c("#EF8A62","#67A9CF"))) %>%
  pmap(., ~ggplot(..2, aes(x=Direction, y=abs(avg_log2FC), fill = Direction )) +
    geom_violin() + #ylim(c(0, m)) + ggtitle(feature) +
    geom_jitter(width = 0.3, alpha = 0.3, size=.1) +
    geom_boxplot(width=0.1, color="black", alpha=0.2) +
    facet_wrap("layers", ncol = l) +
    scale_fill_manual(values = ..3) +
    theme_minimal() + NoLegend() +
    theme(axis.title.x = element_blank()) )

          s1 /
  (s2[[1]] | s2[[2]])
```

## Check overlapping genes

```{r, Overlapping_genes}
######################
# CHECK GENE OVERLAP #
######################
intersect(PP_sig$symbol, epi_sig_genes$gene)
intersect(sig_PP$symbol, sig_epi$gene)

# common DGEs between bulk and individual epithelial layers 
e <- epi_sig_genes %>% 
  group_by(layers) %>%
  nest() %>%
  ungroup() %>%
  mutate(genes = map( data, ~pluck(.x, "gene"))) %>% 
  mutate(genes = setNames(.[["genes"]], .$layers))

t <- sig_epi %>% 
  group_by(layers) %>%
  nest() %>%
  ungroup() %>%
  mutate(genes = map( data, ~pluck(.x, "gene"))) %>% 
  mutate(genes = setNames(.[["genes"]], .$layers))

# all significant (FDR <0.05) genes overlap for each epi layer 
overlap <- map(t$genes, ~intersect(sig_PP$symbol, .x) )

#######################
# PLOTS VENN DIAGRAM #
######################
library(nVennR)
out <- "./"
d <- plotVenn(t$genes, 
         sNames = names(t$genes),
         outFile=paste0(result_dir, "Venn_epi_sig.svg")
         )

# showSVG(d)
knitr::include_graphics(paste0(result_dir, "Venn_epi_sig.svg"))
```

## Identify marker genes to seperate clusters

```{r Get_best_markrs}
#######################################
# FILTER BY P-VAL logFC AND pct.diff #
######################################
# Identify the top genes that have a high difference in expression between the clusters
top20 <- DEGs_table %>%
  mutate(rank = sign(avg_log2FC) * log10(p_val)) %>%
  mutate(Direction = ifelse(avg_log2FC > 0, "UP", "DOWN")) %>%
  group_by(subgroup, Direction) %>%
  top_n(-30, p_val_adj) %>%
  top_n(20, abs(avg_log2FC))
  #nest() %>% mutate(n = map_dbl(data, nrow))

toprank <- DEGs_table %>%
  mutate(rank = sign(avg_log2FC) * log10(p_val)) %>%
  arrange(rank) 
     
top20 <- top20 %>%
  arrange(layers)
# top20[grep("NCR1",top20$gene),]
```

```{r plott_top20_DEGs, fig.height=length(unique(top20$gene))/6+2, fig.width=8.27}
#| fig-format: pdf
############
# DOT PLOT #
############
# Identify marker genes to seperate clusters
DATA_top <- DATA_sub$data[["epi"]]  %>%
  #filter(grepl("^6|7|8|9", .$Clusters )) %>%
  mutate(., feature = paste0(.$Clusters, "_", .$groups))
ord <- niceRplots::getcluster(DATA_top, unique(top20$gene), "feature")

pdf( paste0("./top_10_DEG_subset_epi.pdf"),width=8.27,height=length(ord)/6+2)
par(mfrow=c(1,1), mar=c(7,6,1,5))
plot_dots(DATA_top, names(sort(ord)), clustering = "feature", show_grid = T,main = "top cluster markers",cex.main=1,font.main=1,cex.col = 1,srt = 90,cex.row = 1.1)
abline(v=cumsum(c(table(sub( "_.*","",names(table(DATA_top$feature))))))+0.5)
dev.off()
```

```{r violin_plots, fig.height=(round((length(unique(toprank$gene[1:30])))/3))*2}
################
# VIOLIN PLOTS #
################
library(patchwork)
violin_split.fun <- function(obj, gene_list, split.by, group.by){
  plots <- VlnPlot(obj, features = gene_list, adjust = 1/2,
                   split.by = split.by, group.by = group.by, 
                   pt.size = 0, combine = FALSE, split.plot = TRUE) 
  plots <- map(plots, ~.x + geom_point(alpha = .3, size=.1, show.legend = F,
                                       position = position_jitterdodge(jitter.width=.5)) +
                 theme(axis.title.x = element_blank()))
  p <- wrap_plots(plots, ncol = 3) + plot_layout(guides = "collect")
  h <- round(length(plots)/3)*3
return(tibble(plot=list(p), height = list(h)))
}
plots <- violin_split.fun(DATA_top, unique(toprank$gene[1:30]), "groups", "Clusters")
plots <- violin_split.fun(DATA_top, unique(top20$gene), "groups", "Clusters")
pmap(plots, ~ggsave(paste0(result_dir,"top_DEGs_violin_top_rank",".jpeg"), plot=..1, width = 10, height = ..2))
plots$plot
```

```{r Paulos_DGE_code, eval=FALSE, include=FALSE}
# Paulo's code to calculate differential gene expression between conditions for each cluster group

# calculating how many spots per sample per cluster that we want to have in the differential gene expression
# in order to balance the amount of spots per group in order to avoid p-value inflation
groups <- paste0(DATA$RNA_snn_res.1.5, '_', as.character(DATA$orig.ident) )
DATA$subgroups <- factor(groups)
sample_size <- table(DATA$subgroups)
sample_size[ sample_size > 50 ] <- 50

# Now we can randomly select the amount we just calculated of spots per sample. 
DGE_cells <- lapply(names(sample_size), function(x){ 
  set.seed(1)
  sample( colnames(DATA) [ DATA$subgroups == x ] , size = sample_size[x])
  })
DGE_cells <- unlist(DGE_cells)
# creating a subseted object with all the spots we selected above
DGE_DATA <- DATA[, DGE_cells]
# DGE_DATA <- SetIdent( DGE_DATA , value = "patient_groups")

detable_pat <- lapply(unique(DGE_DATA$RNA_snn_res.1.5),DGE_DATA=DGE_DATA, function(x,DGE_DATA){ 
  temp <- DGE_DATA[,DGE_DATA$RNA_snn_res.1.5 == x]
  temp <- SetIdent( temp , value = "sp_annot")
  detable <- FindAllMarkers( temp, only.pos = T,max.cells.per.ident = 50,
                          logfc.threshold = .1,assay = "RNA",
                          min.pct = 0.05)
  return( cbind(detable,cell_cluster= x) )
})
detable <- do.call(rbind,detable_pat)

# filtering by non-significant p-values
detable <- detable[ detable$p_val < 0.05,  ]
detable$pct.diff <- detable$pct.1 - detable$pct.2
detable$log.pct.diff <- log2( (detable$pct.1+1) / (detable$pct.2+1) )
detable$groups <- paste0(detable$cell_cluster,detable$cluster)
# saving table to file
write.csv2(detable,"results/detable_for_each_cluster_across_conditions.csv")

feature <- paste0(DATA$RNA_snn_res.1.5, '_', as.character(DATA$sp_annot) )
DATA$feature <- factor(feature)

# need to change to more suitable for bulk data
detable %>% group_by(groups)  %>% top_n(-30, p_val) %>% top_n(20, avg_log2FC)  -> top20
#detable %>% group_by(groups)  %>% top_n(-60, p_val) %>% top_n(40, pct.diff) %>% top_n(20, log.pct.diff) -> top5
ord <- niceRplots::getcluster(DATA, unique(top20$gene), "feature")
ord

pdf( paste0("./DGE_subset_INF_vs_NONINF.pdf"),width = 20,height = length(ord)/6+2)
par(mfrow=c(1,1), mar=c(7,6,1,5))
plot_dots(DATA, names(sort(ord)), clustering = "feature", show_grid = T,main = "top cluster markers",cex.main=1,font.main=1,cex.col = 1,srt = 90,cex.row = 1.1)
abline(v=cumsum(c(table(sub( "_.*","",names(table(DATA$feature))))))+0.5)
dev.off()


```

```{r 04a_barplot_top20, fig.width=10, , fig.height=6}
#####################
# BARPLOTS TOP DEGs #
#####################8
top <- top20 %>% slice_min(., n = 10, order_by = p_val_adj, with_ties=F) #%>% nest()
n_gr <- length(unique(top20$Clusters))

#pdf(paste0(result_dir,"top_DEG.pdf"), height=(n_gr/4)*5, width=n_gr*2.5)
par(mfrow=c(n_gr/4, 4), mar = c(4, 6, 3, 1))
for (i in unique(top$Clusters)) {
    barplot(sort(setNames(top$avg_log2FC, top$gene)[top$Clusters == i], F),
        horiz = T, las = 1, main = paste0("Cluster ", i), border = "white", yaxs = "i")
    abline(v = c(0, 0.25), lty = c(1, 2))
}
#dev.off()
```

```{r UMAP_top10_markergenes_plot, include=TRUE, eval=TRUE, fig.height=8}
#| fig-format: jpeg

top <- top20 %>% slice_min(., n = 10, order_by = p_val_adj, with_ties=F) #%>% nest()
# remove all VDJ-genes from list of HVG
remove <- str_subset(top$gene, "^IGH|^IGK|^IGL|^TRA|^TRB|^TRD|^TRG")
top_gr <- top %>%
  ungroup() %>%
  #filter(., !(.$gene %in% remove)) %>%
  group_by(Clusters) %>%
  group_split() %>%
  set_names(., unique(top$Clusters))

################################
# UMAP TOP 10 DOWN AND UP DEGs #
################################
col=c("grey90","grey80","grey60","navy","black")

clus_plot <- plot_clusters.fun(DATA_top, red = "umapharmony", cluster="Clusters") + theme_void() + NoLegend()

grid_genes <- function(plot_list, title){
  title <- ggdraw() + draw_label(paste0("Top 10 Markers for Cluster ", title), fontface='bold')
  g <- plot_grid(plotlist = plot_list,
            ncol = 4)
  g_ <- plot_grid(title, g, ncol=1, rel_heights=c(0.1, 1))
  return(g_)
}

plots <- imap(top_gr, "gene") %>%
  map(., map, ~plot_genes.fun(DATA_top, red = "umapharmony", .x, lable = "Clusters"))

cluster_markers <- plots %>%
  map(., ~c("Clusters"=list(clus_plot), .x)) %>%
  imap(., ~grid_genes(.x, .y ))

cluster_markers[[1]]

imap(cluster_markers, ~ggsave(paste0(result_dir,"Marker_genes_condition_", .y, ".jpg"), 
                              plot=.x, height = 8 ))
ggsave(paste0(result_dir,"Marker_genes_all_condition", ".pdf"), gridExtra::marrangeGrob(grobs=cluster_markers, ncol=1, nrow=1, height = 8))
```

## Session info

```{r}
sessionInfo()
```
